var author = function(r) {
    function rand(min, max) {
        return Math.floor(Math.random() * (max - min)) + min
    }
    var e = r.elm,
    p = r.pla,
    d = "tor" + (new Date()).valueOf() + rand(0, 999999),
    l = $(e).attr("vlaue"),
    t = $(e).parent(),
    h = "",
    O = "",
    y = r.ylv,
	n = r.num,
	z = r.tips,
    o = r.btn,
    auto = r.auto,
    v,
    m,
    x = r.my;
    if(auto==1 && l == ""){
    	l = $.trim($(".singer").attr("data-vlaue"));
    	if(l=='' || l==null){
    		l = yname
    	}
    }
    if(auto == 1 && y =='ycz'){
      	l = $.trim($(".singer").attr("data-vlaue"));
    	if(l=='' || l==null){
    		l = yname
    	}
    }
    if (p == null) {
        p = ""
    }
    if (y == null) {
        y = ""
    }
    function app_image(spid){
    	/*
    	var tmp = (new Date()).valueOf();
    	$.post('https://www.lianhe.art/WeApi/Demo/userHead',{
            params:$.codeJson({
                        nickname: v[i],
                        tmp: tmp
                    }),
            encSeckey:window.btoa($.codeJson(tmp))
        },function(r){
          	if(r.code==0){
				$("." + spid).prepend('<img src="//old.lianhe.art'+r.data.image+'" onerror="this.src=\'//s2-bulid.lianhe.art/images/singer_300.png\'" style="width: 15px;float: left;margin-top: 3px;border-radius: 100%;margin-right: 5px;">');
            }
        });*/
        return;
    }
    if (l != "" && l != null) {
        var v = l.split("+");
        for (var i = 0; i < v.length; i++) {
          	var img = '';
          	var spid = 'z_'+(new Date()).valueOf();
          	if(nickname!=null && v[i]==nickname && userimg!=null){
          		spid = '';
            	img = '<img src="//old.lianhe.art'+userimg+'" onerror="this.src=\'//s2-bulid.lianhe.art/images/singer_300.png\'" style="width: 15px;float: left;margin-top: 3px;border-radius: 100%;margin-right: 5px;">';
            }else{
            	app_image(spid);
              	
            }
            h += '<div class="nick"><span class="'+spid+'">' + img + v[i] + '</span><i class="icon iconfont icon-close"></i></div>'
        }
    }
    function v__() {
        var c = "";
        for (var i = 0; i < $(d + " .lists .nick").length; i++) {
            if (i == 0) {
                c += $(d + " .lists .nick").eq(i).children("span").text()
            } else {
                c += "+" + $(d + " .lists .nick").eq(i).children("span").text()
            }
        }
      	//alert($("[name='filter"+d.replace(".","")+"']").is(":checked"));
      	if($(d + " .lists .nick").length==0 && o && $("[name='filter"+d.replace(".","")+"']").is(":checked")){
        	$(d + " .layui-unselect").click();
        }
        $(d).attr("data-vlaue", c)
    }
    function t__(v) {
      	v = $.trim(v);
        if (v == " " || v == "" || v == null) {
            return
        } else {
          	if($(d + " .lists .nick").length >= n && n!=null){
                $(d + " input").val("");
                TME.warn('只能添加'+n+'位'+z);
                return;
            }
            for (var i = 0; i < $(d + " .lists .nick").length; i++) {
                if ($(d + " .lists .nick").eq(i).children("span").text() == v) {
                    $(d + " input").val("");
                    return TME.warn('"' + v + '"<br>已存在')
                }
            }
          	var img = '';
          	var spid = 'z_'+(new Date()).valueOf();
          	if(nickname!=null && v==nickname && userimg!=null){
          		spid = '';
            	img = '<img src="//old.lianhe.art'+userimg+'" onerror="this.src=\'//s2-bulid.lianhe.art/images/singer_300.png\'" style="width: 15px;float: left;margin-top: 3px;border-radius: 100%;margin-right: 5px;">';
            }else{
              	var spid = 'z_'+(new Date()).valueOf();
              	
            	var tmp = (new Date()).valueOf();
            	$.post('https://www.lianhe.art/WeApi/Demo/userHead',{
                    params:$.codeJson({
                                nickname: v,
                                tmp: tmp
                            }),
                    encSeckey:window.btoa($.codeJson(tmp))
                },function(r){
                  	if(r.code==0){
						$("." + spid).prepend('<img src="//old.lianhe.art'+r.data.image+'" onerror="this.src=\'//s2-bulid.lianhe.art/images/singer_300.png\'" style="width: 15px;float: left;margin-top: 3px;border-radius: 100%;margin-right: 5px;">');
                    } 
                });
              	
            }
			var h = '<div class="nick"><span class="'+spid+'">' + img + v + '</span><i class="icon iconfont icon-close"></i></div>';
            $(d + " .input").before(h);
            $(d + " input").val("");
            v__();
        }
    }
  	if(o != null && o == true){
      	var f = 'filter'+d, C = 'checked';
      	if(l!=nickname){
        	C = '';   
        }
    	O = '<div class="m_"><input type="checkbox" name="'+f+'" data-d=".'+d+'" lay-skin="primary" lay-filter="'+f+'" title="我是'+z+'" '+C+'></div>';
    }
	layui.use(['form', 'upload'], function(){
        var form = layui.form,
            upload = layui.upload;
		m = '<div class="author ' + d + " " + y + '" data-vlaue="' + l + '">' + '		<div class="lists">' + h + '			<div class="input">' + '				<input type="text" placeholder="' + p + '" autocomplete="off">' + "			</div>" + '         '+O+'<div class="focus"></div>' + "		</div>" + "</div>";
    	t.html(m);
      	form.render();
      	form.on('checkbox(filter'+d+')', function(data){
          var check = data.elem.checked;
          
          if(check===true){
            $($(data.elem).attr("data-d") + ' .lists .nick').remove();
          	t__(nickname);
            v__();
          }else{
          	$($(data.elem).attr("data-d") + ' .lists .nick').remove();
            v__();
          }
        });
        d = "." + d;
        $(d + " .focus").on("click",
        function() {
            $(d + " .input input").focus();
        });
        $(d + " .lists").delegate(".nick i", "click",
        function() {
            var prs = $(this).parent();
            if(x){
              if(nickname==prs.text()){
                TME.warn("需包含自己");
                return;
              }
            }
            prs.remove();
            v__()
        });
        $(d + " input").blur(function() {
            t__($(d + " input").val());
        });
        var keynum_del = 0;
        $(d + " .input input").on("keydown",
        function(event) {
            var keynum = (event.keyCode ? event.keyCode: event.which),
            val = $(d + " .input input").val();
            if (keynum == "13") {
                t__(val)
            }
            if (keynum == "8") {
                if (val == "") {
                    keynum_del++;
                    if (keynum_del == 2) {
                      	var _n = $(this).parent().prev();
						if(nickname==_n.text()){
                            TME.warn("需包含自己");
                            return;
                        }else{
                          _n.remove();
                          keynum_del = 0;
                          v__();
                        }
                    }
                    //console.log(keynum_del);
                }
            }
        });
    });
};
$.author = author;

var author_demo = function(r){
    function rand(min,max) {
        return Math.floor(Math.random()*(max-min))+min;
    }
    var e = r.elm,
        m = $(e),
		t = m.parent(),
        n = m.attr("data-name"),
        p = m.attr("data-per"),
        i = r.title,
        y = r.ylv,
        d = 'author_demo_'+rand(00000,99999),
        k = r.to,
        f = m.attr("data-filekey");
  	var author = n.split('+'),
        per = p.split('+'),
        author_html = '',
        author_edit_html = '';
  	for(var x=0;x<author.length;x++){
      	if(author[x]!='' && per[x]!=''){
            author_html += '<div class="authors">\
                                <span class="name">'+author[x]+'</span>\
                                <span class="per">('+per[x]+'%)</span>\
                            </div>';
        }
    }
  	if(f=="" || f==null){
    	f = md5(d+rand(00000,99999));
    }
    var html = '<div class="author_demo '+d+' '+y+'" data-name="'+n+'" data-per="'+p+'" data-filekey="'+f+'">\
                  <div class="input_demo">\
                  '+author_html+'\
              	  </div>\
                <div class="edit_demo"><span class="icon iconfont icon-edit-square"></span> 编辑</div>\
            </div>';
  	t.html(html);
  	var z = $("."+d);
  	
  	$('.'+d).on("click", function(){
      	n = z.attr("data-name");
        p = z.attr("data-per");
    	author = n.split('+'),
        per = p.split('+'),
        author_edit_html = '';
      	for(var x=0;x<author.length;x++){
            author_edit_html += '<div class="header aut">\
                                    <div class="name">\
                                      <input type="text" autocomplete="off"value="'+author[x]+'" placeholder="请在此处输入真实姓名或艺名" class="ui-input__inner">\
                                    </div>\
                                    <div class="per">\
                                        <input type="number" autocomplete="off" value="'+per[x]+'" placeholder="请在此处输入权利比例" class="ui-input__inner">\
                                    </div>\
                                    <span class="icon iconfont icon-close-circle-fill close-author" style="display:none;"></span>\
                                 </div>';
        }
        if(author_edit_html==''){
            author_edit_html = '<div class="header aut">\
                                    <div class="name">\
                                        <input type="text" autocomplete="off" placeholder="请在此处输入真实姓名或艺名" class="ui-input__inner">\
                                    </div>\
                                    <div class="per">\
                                        <input type="number" autocomplete="off" placeholder="请在此处输入权利比例" class="ui-input__inner">\
                                    </div>\
                                    <span class="icon iconfont icon-close-circle-fill close-author" style="display:none;"></span>\
                                </div>';
        }
    	layui.use(['form', 'upload','layer'], function(){
            var form = layui.form,
                upload = layui.upload,
                layer = layui.layer;
            layer.open({
                type: 1,
                skin: 'ui-layer',
                title: ' ',
                resize: true,
                area: '600px',
                content: '<div class="ui-content">\
                              <h2>'+i+'</h2>\
                              <div class="content">\
								  <div class="author_demo_lists">\
                                      <div class="header">\
                                          <div class="name">作者</div>\
                                          <div class="per">权利拥有占比 (%)</div>\
                                      </div>\
									  '+author_edit_html+'\
              						  <div class="ui-blue ui-icon-left ui-p10 author_add_button"><span class="icon iconfont icon-plus-circle"></span> 添加</div>\
									  <p class="ui-hite ui-p10 ui-icon-left"><span class="icon iconfont icon-warning-circle"></span>至音乐人: 词曲作者必须有一项中包含您的创作，若词曲中包含其他人创作，则需要上传其他参与者的声明授权文件，并确定彼此的“权利拥有占比” (多个作者的权利占比相加必需等于100%)</p>\
                                  </div>\
                                  <div class="word-upload">\
                                      <div class="lists"></div>\
                                      <div class="btn">\
                                          <div class="ui-btn ui-icon-left upload-file"><span class="icon iconfont icon-cloud-upload"></span> 上传授权文件</div>\
                                          <a href="//s2-bulid.lianhe.art/file/授权书模板.zip"><div class="ui-btn d ui-icon-left"><span class="icon iconfont icon-cloud-download"></span> 下载模板</div></a>\
                                      </div><p>* 支持xlsx、xls、pdf、doc、docx、png、jpg格式的多个文件</p>\
                                  </div>\
                              </div>\
                          </div>',
                btn: ['确定','取消'],
                yes: function(index){
              		var x_b = 0;
              		if(y=='word'){
                        var song = z.parent().parent().parent().find(".song"),
                            v_g = song.find(".authors");
                        for(var i=0;i<v_g.length;i++){
                            var d_x = song.find(".authors").eq(i),
                                n_m = d_x.children(".name").text();
                            if(n_m==name || n_m==nickname){
                                x_b = x_b + 1;
                            }
                        }
                    }
              		if(y=='song'){
                        var word = z.parent().parent().parent().find(".word"),
                            v_g = word.find(".authors");
                        for(var i=0;i<v_g.length;i++){
                            var d_x = word.find(".authors").eq(i),
                                n_m = d_x.children(".name").text();
                            if(n_m==name || n_m==nickname){
                                x_b = x_b + 1;
                            }
                        }
            		}
					var thi = $(".author_demo_lists .aut"),
              			count = thi.length;
					if(count==0){
                    	TME.warn("请输入至少一位作者");
              			return;
                    }
              		var data_name = '',
              			data_per = '',
              			data_author_html = '',
                       	per_count = 0,
                        q_c = 0;
              		for(var i=0;i<count;i++){
            			var names = $.trim(thi.eq(i).children(".name").children("input").val()),
              				pers = $.trim(thi.eq(i).children(".per").children("input").val());
                      	if(names==name || names==nickname){
                        	x_b = x_b + 1;
                        }else{
                        	q_c = q_c + 1;
                        }
              			if(names==""){
                        	TME.warn("作者不能为空");
                            return;
                        }
              			if(pers==""){
                        	TME.warn("权利拥有占比不能为空");
                            return;
                        }
                      	if(parseInt(pers)<1){
                        	TME.warn("权利拥有占比不能为零");
                            return;
                        }
              			if(i==0){
            				data_name += names;
              				data_per += pers;
            			}else{
                       		data_name += '+'+names;
              				data_per += '+'+pers;
                       	}
                       	data_author_html += '<div class="authors">\
                        					<span class="name">'+names+'</span>\
                        					<span class="per">('+pers+'%)</span>\
                        				</div>';
              			per_count = per_count+parseInt(pers);
            		}
          			if(k==true){
                    	if(x_b==0){
                        	TME.warn("词曲作者必须有一项中包含您");
                            return;
                        }
                    }
          			if(per_count!=100){
                    	TME.warn("权利占比相加必需等于100%");
                        return;
                    }
          			var d_a = {},
          			    c_t = $(".word-upload .lists li"),
                        d_n = c_t.length;
          			if(parseInt(q_c) > 0){
                    	if(parseInt(d_n) == 0){
                        	TME.warn("请上传授权文件");
                          	return;
                        }
                    }
              		z.attr("data-name",data_name).attr("data-per",data_per);
          			z.children(".input_demo").html(data_author_html);
          			if(c_t.length!=0){
                        for(var i=0;i<d_n;i++){
                            d_a[i] = {
                                filename: c_t.eq(i).attr("data-filename"),
                                url: c_t.eq(i).attr("data-url")
                            }
                          	if(d_a[i]['url']==""){
                            	TME.warn("请等待授权文件上传完毕后再进行此操作");
                              	return;
                            }
                        }
                        var tmp = (new Date()).valueOf(),
                            s = {
                                filekey: z.attr("data-filekey"),
                                data: d_a,
                                tmp: tmp
                            };
                      	TMES_v2("请稍等，正在验校授权文件...");
                        $.post('/WeApi/Demo/file',{
                            params:$.codeJson(s),
                            encSeckey:window.btoa($.codeJson(tmp))
                        }, function(r){
                          	$(".TMES_v2").remove();
                            if(r.code!=0){
                                TME.warn(r.msg);
                                return;
                            }
                        });
                    }
          			layer.close(index);
                }
            });
      		$.getJSON("/WeApi/demo/file_lists", {filekey: z.attr("data-filekey")}, function(r){
              	var h_c = '';
        		if(r.code==0){
                	for(var i=0;i<r.data.length;i++){
                    	h_c += '<li class="lists_'+r.data[i].id+'" data-url="'+r.data[i].url+'" data-id="'+r.data[i].id+'" data-filename="'+r.data[i].filename+'">\
                                  <div class="file_name"><a href="'+r.data[i].url+'" target="_blank">'+r.data[i].filename+'</a>\
                                  </div>\
                                  <div class="per">\
                                    <span class="icon iconfont icon-close-circle-fill close-file"></span>\
                                  </div>\
                      			</li>';
                    }
                }
              	$(".word-upload .lists").html(h_c);
            });
            upload.render({
                elem: '.upload-file'
                ,xhr:xhrOnProgress
                ,accept:'file'
                ,exts:'xlsx|xls|pdf|doc|docx|png|jpg'
                ,drag:false
                ,multiple:true
                ,url: '/WeApi/Upload/post?type=demo-file'
                ,before: function(obj){
                  	obj.preview(function(index, file, result){
                		$(".word-upload .lists").append('<li class="lists_'+index+'" data-url="" data-id="" data-filename="'+file.name+'">\
												  	  <div class="file_name"><a href="#" target="_blank">'+file.name+'</a></div>\
													  <div class="per">0%</div>\
                                                  </li>');
                    });
                }
              	,progress:function(index,value){
                  	$('.lists_'+index+' .per').html(value+'%');
                }
              	,done: function(res, index, result){
                  	$('.lists_'+index).attr("data-url",res.url);
                  	$('.lists_'+index+' a').attr("href",res.url);
                	$('.lists_'+index+' .per').html('<span class="icon iconfont icon-close-circle-fill close-file"></span>');
                }
            });
          	$(".word-upload").on("click", ".close-file",function(){
              	var t_x = $(this).parent().parent();
              	var tmp = (new Date()).valueOf(),
                    s = {
                      filekey: z.attr("data-filekey"),
                      id: t_x.attr("data-id"),
                      tmp: tmp
                    };
                $.post('/WeApi/Demo/file_delete',{
                  	params:$.codeJson(s),
                  	encSeckey:window.btoa($.codeJson(tmp))
                }, function(r){
                    if(r.code!=0){
                      	TME.warn(r.msg);
                      	return;
                    }else{
                      	t_x.remove();
                    }
                });
            });
          	if(author.length>1){
            	$(".author_demo_lists .close-author").show();
              	$(".author_add_button").hide();
            }
          	$(".author_demo_lists").on("click", ".close-author",function(){
              	if($(".author_demo_lists .header").length>1){
            		$(this).parent().remove();
                  	$(".author_demo_lists .close-author").hide();
                 	$(".author_add_button").show();
                }
            });
          	$(".author_add_button").on("click",function(){
            	$(this).before('<div class="header aut">\
                                  <div class="name">\
                                      <input type="text" placeholder="请在此处输入真实姓名或艺名" class="ui-input__inner">\
                                  </div>\
                                  <div class="per">\
                                      <input type="number" placeholder="请在此处输入权利比例" class="ui-input__inner">\
                                  </div>\
								  <span class="icon iconfont icon-close-circle-fill close-author" style="display:none;"></span>\
                                </div>');
              	if($(".author_demo_lists .header").length>1){
                	$(this).hide();
                  	$(".author_demo_lists .close-author").show();
                }
            });
        });
    });
}
$.author_demo = author_demo;


